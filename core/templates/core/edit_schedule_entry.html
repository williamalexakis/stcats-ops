<!-- Copyright © William Alexakis. All Rights Reserved. Use governed by LICENSE file. -->

{% extends "base.html" %}

{% block title %}Edit Schedule Entry - CS Dept Platform{% endblock %}

{% block content %}

<div class="page-subheader">
    <a href="{% url 'scheduler' %}" class="back-link">
        <i class="fa-solid fa-arrow-left"></i> Back to Scheduler
    </a>

    <h2 class="page-subheader__title">Edit Schedule Entry</h2>
</div>

<div class="card">
    <form method="post" class="form-grid">

        {% csrf_token %}

        <div class="form-grid-two">
            <div>
                <label for="teacher" class="field-label">
                    <i class="fa-solid fa-chalkboard-user"></i> Teacher
                </label>

                <select
                    id="teacher"
                    name="teacher"
                    required
                    class="select-control"
                >
                    <option value="">Select teacher...</option>

                    {% for teacher in teachers %}

                        <option value="{{ teacher.id }}" {% if teacher.id == entry.teacher.id %}selected{% endif %}>{{ teacher.username }}</option>

                    {% endfor %}

                </select>
            </div>

            <div>
                <label for="classroom" class="field-label">
                    <i class="fa-solid fa-door-open"></i> Classroom
                </label>

                <select
                    id="classroom"
                    name="classroom"
                    required
                    class="select-control"
                >
                    <option value="">Select classroom...</option>

                    {% for classroom in classrooms %}

                        <option value="{{ classroom.id }}" {% if classroom.id == entry.classroom.id %}selected{% endif %}>{{ classroom.display_name }}</option>

                    {% endfor %}
                </select>
            </div>
        </div>

        <div class="form-grid-two">
            <div>
                <label for="subject" class="field-label">
                    <i class="fa-solid fa-book"></i> Subject
                </label>

                <select
                    id="subject"
                    name="subject"
                    required
                    class="select-control"
                >
                    <option value="">Select subject...</option>

                    {% for subject in subjects %}

                        <option value="{{ subject.id }}" {% if subject.id == entry.subject.id %}selected{% endif %}>{{ subject.display_name }}</option>

                    {% endfor %}
                </select>
            </div>

            <div>
                <label for="course" class="field-label">
                    <i class="fa-solid fa-graduation-cap"></i> Course
                </label>

                <select
                    id="course"
                    name="course"
                    required
                    class="select-control"
                >
                    <option value="">Select course...</option>

                    {% for course in courses %}

                        <option value="{{ course.id }}" {% if course.id == entry.course.id %}selected{% endif %}>{{ course.display_name }}</option>

                    {% endfor %}
                </select>
            </div>
        </div>

        <div>
            <label for="group" class="field-label">
                <i class="fa-solid fa-people-group icon-group"></i> Group
            </label>

            <select
                id="group"
                name="group"
                required
                class="select-control"
            >
                <option value="">Select group...</option>

                {% for group in groups %}

                    <option value="{{ group.id }}" {% if entry.group and group.id == entry.group.id %}selected{% endif %}>{{ group.display_name }}</option>

                {% endfor %}

            </select>
        </div>

        <div>
            <label for="date" class="field-label">
                <i class="fa-solid fa-calendar-days"></i> Date
            </label>

            <input
                type="date"
                id="date"
                name="date"
                value="{{ entry.date|date:'Y-m-d' }}"
                required
                class="select-control"
            />
        </div>

        <div class="form-grid-two">
            <div>
                <label for="start_time" class="field-label">
                    <i class="fa-solid fa-clock"></i> Start Time
                </label>

                <input
                    type="time"
                    id="start_time"
                    name="start_time"
                    value="{{ entry.start_time|time:'H:i' }}"
                    required
                    class="select-control"
                />
            </div>

            <div>
                <label for="end_time" class="field-label">
                    <i class="fa-solid fa-clock"></i> End Time
                </label>

                <input
                    type="time"
                    id="end_time"
                    name="end_time"
                    value="{{ entry.end_time|time:'H:i' }}"
                    required
                    class="select-control"
                />
            </div>
        </div>

        <div class="mt-16">
            <label>
                <input
                    type="checkbox"
                    id="is_recurring"
                    name="is_recurring"
                    {% if entry.is_recurring %}checked{% endif %}
                />
                <span class="recurring-toggle__label">
                    <i class="fa-solid fa-rotate-right"></i>
                    Recurring entry
                </span>
            </label>

            <p class="text-secondary text-small mt-4">
                When enabled, additional entries are created on the same day at the interval you choose.
                {% if has_recurrence_peers %}
                    Select "All {{ recurrence_count }} entries in this series" below to update the entire sequence.
                {% endif %}
            </p>
        </div>

        {% with entry_is_recurring=entry.is_recurring %}
            <div
                class="form-grid-two mt-16 recurrence-fields{% if not entry_is_recurring %} recurrence-fields--hidden{% endif %}"
                data-recurring-fields
                {% if entry_is_recurring %}
                    aria-hidden="false"
                {% else %}
                    hidden
                    aria-hidden="true"
                {% endif %}
            >
                <div>
                    <label for="recurrence_interval_days" class="field-label">
                        <i class="fa-solid fa-calendar-week"></i> Repeat every (days)
                    </label>

                    <input
                        type="number"
                        id="recurrence_interval_days"
                        name="recurrence_interval_days"
                        min="1"
                        step="1"
                        class="select-control"
                        data-recurring-input
                        value="{{ entry.recurrence_interval_days|default_if_none:'' }}"
                        {% if not entry_is_recurring %}disabled{% endif %}
                    />
                </div>

                <div>
                    <label for="recurrence_total_occurrences" class="field-label">
                        <i class="fa-solid fa-hashtag"></i> Number of occurrences
                    </label>

                    <input
                        type="number"
                        id="recurrence_total_occurrences"
                        name="recurrence_total_occurrences"
                        min="2"
                        step="1"
                        class="select-control"
                        data-recurring-input
                        value="{{ entry.recurrence_total_occurrences|default_if_none:'' }}"
                        {% if not entry_is_recurring %}disabled{% endif %}
                    />

                    <p class="text-secondary text-small mt-2">
                        Includes the first scheduled entry.
                    </p>
                </div>
            </div>
        {% endwith %}

        {% if entry.recurrence_group %}
            <div class="mt-4 text-small text-secondary">
                <i class="fa-solid fa-rotate-right"></i>
                Recurring entry
                {% if has_recurrence_peers %}
                    ({{ entry.recurrence_index }} of {{ recurrence_count }})
                {% endif %}
                {% if entry.recurrence_interval_days %}
                    • repeats every {{ entry.recurrence_interval_days }} day{{ entry.recurrence_interval_days|pluralize }}
                {% endif %}
            </div>
        {% endif %}

        {% if has_recurrence_peers %}
            <fieldset class="mt-16">
                <legend class="field-label">
                    <i class="fa-solid fa-pen-to-square"></i> Apply changes to
                </legend>

                <div>
                    <label>
                        <input
                            type="radio"
                            name="recurrence_scope"
                            value="single"
                            checked
                        />
                        This entry only
                    </label>
                </div>

                <div class="mt-2">
                    <label>
                        <input
                            type="radio"
                            name="recurrence_scope"
                            value="series"
                        />
                        All {{ recurrence_count }} entries in this series
                    </label>
                </div>

                <p class="text-secondary text-small mt-2">
                    Date changes shift each occurrence forward or backward by the same number of days.
                </p>
            </fieldset>
        {% endif %}

        <div class="action-buttons">
            <button type="submit" class="chat-submit">
                <i class="fa-solid fa-check"></i>

                Save Changes

            </button>

            <a href="{% url 'scheduler' %}" class="btn-outline">
                <i class="fa-solid fa-xmark"></i>

                Cancel

            </a>
        </div>
    </form>
</div>

{% endblock %}

{% block scripts %}
    {{ block.super }}
    <script>
    document.addEventListener('DOMContentLoaded', function () {
        const toggle = document.getElementById('is_recurring');
        const inputs = document.querySelectorAll('[data-recurring-input]');
        const container = document.querySelector('[data-recurring-fields]');

        if (!toggle) {
            return;
        }

        const applyState = () => {
            const show = toggle.checked;

            if (container) {
                container.hidden = !show;
                container.classList.toggle('recurrence-fields--hidden', !show);
                container.setAttribute('aria-hidden', String(!show));
            }

            inputs.forEach((input) => {
                input.disabled = !show;
                if (!show) {
                    input.value = '';
                }
            });
        };

        applyState();
        toggle.addEventListener('change', applyState);
    });
    </script>
{% endblock %}

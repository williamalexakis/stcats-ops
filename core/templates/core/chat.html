{% extends "base.html" %}

{% block title %}Chat - CS Dept Platform{% endblock %}

{% block content %}

<div class="page-header">
    <div class="page-header__group">
        <h1 class="page-header__title">Chat</h1>

        <td class="count-badge-wrapper">
            <span class="count-badge">
                {{ room.name }}
            </span>
        </td>
    </div>
</div>

<div class="card chat-thread">

    {% if chat_messages %}

        <div class="chat-thread__messages">

            {% for message in chat_messages %}

                <div class="chat-message {% if message.is_announcement %}chat-message--announcement{% endif %}">

                    <div class="chat-message__header">
                        <div class="chat-message__author">

                            <div class="chat-message__avatar {% if message.author.is_superuser or message.author.groups.all.0.name == 'admin' %}chat-message__avatar--admin{% else %}chat-message__avatar--default{% endif %}">
                                {{ message.author.username|first|upper }}
                            </div>

                            <div class="chat-message__details">
                                <div class="chat-message__identity">
                                    <strong class="chat-message__name">{{ message.author.username }}</strong>

                                    {% if message.author.is_superuser %}

                                        <i class="fa-solid fa-crown icon-superuser chat-message__role-icon" title="Superuser"></i>

                                    {% elif message.author.groups.all.0.name == 'admin' %}

                                        <i class="fa-solid fa-user-shield icon-admin chat-message__role-icon" title="Admin"></i>

                                    {% endif %}

                                    {% if message.is_announcement %}

                                        <span class="badge badge--primary">
                                            <i class="fa-solid fa-bullhorn"></i> Announcement
                                        </span>

                                    {% endif %}

                                    {% if message.is_pinned %}

                                        <span class="badge badge--success">
                                            <i class="fa-solid fa-thumbtack"></i> Pinned
                                        </span>

                                    {% endif %}
                                </div>

                                <div class="chat-message__timestamps">

                                    {{ message.creation_date|date:"d/m/Y H:i" }}

                                    {% if message.edit_date %}

                                        <span class="chat-message__edited">
                                            <i class="fa-solid fa-pen chat-message__edited-icon"></i> edited
                                        </span>

                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="chat-message__actions">

                            {% if message.author == request.user %}

                                <a href="{% url 'edit_message' message.id %}"
                                   class="chat-action chat-action--muted"
                                   title="Edit message">
                                    <i class="fa-solid fa-pen"></i>
                                </a>

                                <a href="{% url 'delete_message' message.id %}"
                                   onclick="return confirm('Delete this message?');"
                                   class="chat-action chat-action--danger"
                                   title="Delete message">
                                    <i class="fa-solid fa-trash"></i>
                                </a>

                            {% elif request.user.is_superuser or request.user.groups.all.0.name == 'admin' %}

                                {% if not message.author.is_superuser %}

                                    <a href="{% url 'delete_message' message.id %}"
                                       onclick="return confirm('Delete this message?');"
                                       class="chat-action chat-action--danger"
                                       title="Delete message">
                                        <i class="fa-solid fa-trash"></i>
                                    </a>

                                {% endif %}

                            {% endif %}

                        </div>
                    </div>

                    <div class="chat-message__content">
                        {{ message.body|linebreaksbr }}
                    </div>
                </div>

            {% endfor %}

        </div>

    {% else %}

        <div class="chat-empty">
            <i class="fa-solid fa-comment-dots chat-empty__icon"></i>

            <p class="chat-empty__text">No messages available.</p>
        </div>

    {% endif %}

</div>

<div class="card">
    <h3 class="form-section__title">
        <i class="fa-solid fa-paper-plane"></i> Send Message
    </h3>

    <form method="post" class="form-vertical">

        {% csrf_token %}

        <div>
            <textarea
                id="body"
                name="body"
                rows="4"
                placeholder="Type your message here..."
                required
                class="textarea-input"
            ></textarea>
        </div>

        <div class="form-options">
            <label class="form-option">
                <input
                    type="checkbox"
                    id="is_announcement"
                    name="is_announcement"
                    class="form-option__checkbox"
                    onchange="document.getElementById('pinned-option').style.display = this.checked ? 'flex' : 'none';"
                />

                <span class="form-option__label">
                    <i class="fa-solid fa-bullhorn icon-teacher"></i> Mark as Announcement
                </span>
            </label>

            <label id="pinned-option" class="form-option form-option--hidden">
                <input
                    type="checkbox"
                    id="is_pinned"
                    name="is_pinned"
                    class="form-option__checkbox"
                />

                <span class="form-option__label">
                    <i class="fa-solid fa-thumbtack icon-success"></i> Pin Announcement
                </span>
            </label>
        </div>

        <div>
            <button type="submit" class="chat-submit">
                <i class="fa-solid fa-paper-plane"></i>

                Send Message

            </button>
        </div>
    </form>
</div>

<script>
// Auto-scroll to bottom on page load
window.addEventListener('DOMContentLoaded', function() {
    var chatContainer = document.querySelector('.chat-thread');

    if (chatContainer) {
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }
});
</script>

{% endblock %}

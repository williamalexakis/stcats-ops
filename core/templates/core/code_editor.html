{% extends "base.html" %}

{% block title %}Code Editor - CS Dept Platform{% endblock %}

{% block head %}

<style>

    .editor-page {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .editor-header {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        gap: 16px;
        align-items: flex-end;
    }

    .editor-header h1 {
        margin: 0;
        font-size: 28px;
    }

    .editor-header p {
        margin: 4px 0 0 0;
        color: var(--text-secondary);
        font-size: 14px;
        max-width: 540px;
    }

    .editor-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
    }

    .btn-icon {
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .btn-icon i {
        font-size: 14px;
    }

    .btn-run {
        background: var(--button-bg);
        color: var(--button-text);
        border-color: var(--button-bg);
        border-radius: 8px;
        padding: 10px 20px;
        border: 1px solid var(--button-bg);
        box-shadow: 0 3px 8px rgba(59, 130, 246, 0.25);
    }

    .btn-run:hover {
        background: var(--button-hover);
        border-color: var(--button-hover);
        box-shadow: 0 6px 14px rgba(59, 130, 246, 0.35);
    }

    .btn-stop {
        background: var(--error-bg);
        color: var(--error-text);
        border-color: var(--error-border);
        border-radius: 8px;
        padding: 10px 20px;
        border: 1px solid var(--error-border);
        box-shadow: 0 3px 8px rgba(248, 113, 113, 0.25);
    }

    .btn-stop:hover {
        background: var(--error-border);
        color: #ffffff;
        box-shadow: 0 6px 14px rgba(248, 113, 113, 0.35);
    }

    .editor-actions button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        box-shadow: none;
        transform: none !important;
    }

    .editor-panels {
        display: grid;
        grid-template-columns: minmax(0, 1.2fr) minmax(0, 0.8fr);
        gap: 20px;
        min-height: 520px;
    }

    .editor-pane,
    .output-pane {
        display: flex;
        flex-direction: column;
        border: 1px solid var(--border-color);
        border-radius: 12px;
        background: var(--bg-primary);
        box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.02);
        overflow: hidden;
        min-height: 480px;
    }

    .output-pane {
        background: var(--bg-secondary);
    }

    .editor-pane {
        position: relative;
    }

    #code-editor {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
    }

    .output-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 14px 16px;
        background: var(--bg-primary);
        border-bottom: 1px solid var(--border-color);
    }

    .output-header span {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
        color: var(--text-primary);
    }

    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        border-radius: 999px;
        padding: 6px 12px;
        font-size: 12px;
        font-weight: 600;
        transition: background-color 0.2s ease, color 0.2s ease;
    }

    .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
    }

    .status-idle {
        background: var(--bg-secondary);
        color: var(--text-secondary);
    }

    .status-idle .status-dot {
        background: var(--text-tertiary);
    }

    .status-loading {
        background: var(--info-bg);
        color: var(--info-text);
    }

    .status-loading .status-dot {
        background: var(--info-text);
    }

    .status-running {
        background: var(--button-bg);
        color: var(--button-text);
    }

    .status-running .status-dot {
        background: var(--button-text);
    }

    .status-success {
        background: var(--success-bg);
        color: var(--success-text);
    }

    .status-success .status-dot {
        background: var(--success-text);
    }

    .status-error,
    .status-stopped {
        background: var(--error-bg);
        color: var(--error-text);
    }

    .status-error .status-dot,
    .status-stopped .status-dot {
        background: var(--error-text);
    }

    .output-area {
        flex: 1;
        padding: 16px;
        overflow: auto;
        font-family: "Fira Code", "JetBrains Mono", "Courier New", monospace;
        font-size: 14px;
        line-height: 1.5;
        color: var(--text-primary);
        background: var(--bg-secondary);
    }

    .output-area .output-line {
        margin: 0 0 6px 0;
        white-space: pre-wrap;
        word-break: break-word;
    }

    .output-area .output-line:last-child {
        margin-bottom: 0;
    }

    .output-line.output-error {
        color: var(--error-text);
    }

    .output-line.output-stderr {
        color: var(--warning-text);
    }

    .output-line.output-info {
        color: var(--info-text);
    }

    .monaco-editor,
    .monaco-editor-background,
    .monaco-editor .margin {
        background: transparent !important;
    }

    .editor-footer {
        font-size: 12px;
        color: var(--text-tertiary);
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        justify-content: space-between;
    }

    @media (max-width: 1024px) {
        .editor-panels {
            grid-template-columns: 1fr;
        }

        .editor-pane,
        .output-pane {
            min-height: 320px;
        }
    }
</style>

{% endblock %}

{% block content %}

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
    <div style="display: flex; align-items: center; gap: 20px;">
        <h1 style="margin: 0 0 8px 0;">Code Editor</h1>

        <td style="padding: 16px; color: var(--text-primary);">
            <span style="background: var(--success-bg); color: var(--success-text); padding: 4px 10px; border-radius: 6px; font-size: 17px; font-weight: 500;">
                <i class="fa-brands fa-python" style="margin-right: 6px;"></i>

                Python

            </span>
        </td>
    </div>
</div>

<div class="card editor-page">
    <div class="editor-header">

        <div class="editor-actions">
            <button id="run-button" class="btn btn-icon btn-run" type="button" title="Run code">
                <i class="fa-solid fa-play"></i>

                Run

            </button>

            <button id="stop-button" class="btn btn-icon btn-stop" type="button" title="Stop execution" disabled>
                <i class="fa-solid fa-stop"></i>

                Stop

            </button>

            <button id="import-button"
                    type="button"
                    title="Import .py file"
                    style="color: var(--info-text);
                           padding: 8px 16px;
                           border-radius: 6px;
                           text-decoration: none;
                           font-size: 15px;
                           font-weight: 500;
                           display: inline-flex;
                           align-items: center;
                           gap: 6px;
                           border: 2px solid var(--info-border);
                           background: var(--info-bg);
                           transition: all 0.2s ease;"
                    onmouseover="this.style.borderColor='var(--info-border)'; this.style.background='var(--info-border)'; this.style.color='white';"
                    onmouseout="this.style.borderColor='var(--info-border)'; this.style.background='var(--info-bg)'; this.style.color='var(--info-text)';">
                <i class="fa-solid fa-file-arrow-up"></i>

                Import

            </button>

            <button id="export-button"
                    type="button"
                    title="Download code as file"
                    style="color: var(--success-text);
                           padding: 8px 16px;
                           border-radius: 6px;
                           text-decoration: none;
                           font-size: 15px;
                           font-weight: 500;
                           display: inline-flex;
                           align-items: center;
                           gap: 6px;
                           border: 2px solid var(--success-border);
                           background: var(--success-bg);
                           transition: all 0.2s ease;"
                    onmouseover="this.style.borderColor='var(--success-border)'; this.style.background='var(--success-border)'; this.style.color='white';"
                    onmouseout="this.style.borderColor='var(--success-border)'; this.style.background='var(--success-bg)'; this.style.color='var(--success-text)';">
                <i class="fa-solid fa-file-arrow-down"></i>

                Export

            </button>

            <div style="font-size: 12px; margin-left: 20px;">
                <span>
                    <i class="fa-solid fa-circle-info" style="margin-right: 6px;"></i>

                    Import supports UTF-8 Python files up to 200 KB.

                </span>
            </div>
        </div>
    </div>

    <div class="editor-panels">
        <div class="editor-pane">
            <div id="code-editor" aria-label="Python code editor"></div>
        </div>

        <div class="output-pane">
            <div class="output-header">
                <span>
                    <i class="fa-solid fa-terminal"></i>

                    Output

                </span>

                <span id="status-badge" class="status-badge status-idle">
                    <span class="status-dot"></span>

                    Idle

                </span>
            </div>

            <div id="output-area" class="output-area" role="region" aria-live="polite"></div>
        </div>
    </div>
</div>

<input type="file" id="file-input" accept=".py,.txt" style="display:none;">

{% endblock %}

{% block scripts %}

<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js" referrerpolicy="no-referrer"></script>
<script>
    (function () {
        const initialCode = `{{ initial_code|escapejs }}`;
        const PYODIDE_BASE_URL = "https://cdn.jsdelivr.net/pyodide/v0.24.1/full/";

        const runButton = document.getElementById("run-button");
        const stopButton = document.getElementById("stop-button");
        const importButton = document.getElementById("import-button");
        const exportButton = document.getElementById("export-button");
        const fileInput = document.getElementById("file-input");
        const statusBadge = document.getElementById("status-badge");
        const outputArea = document.getElementById("output-area");

        let editorInstance = null;
        let worker = null;
        let workerReady = false;
        let isRunning = false;
        let currentFilename = "code.py";
        let queuedCode = null;

        function updateStatus(state, label) {
            const validStates = ["idle", "loading", "running", "success", "error", "stopped"];
            const safeState = validStates.includes(state) ? state : "idle";

            statusBadge.className = "status-badge status-" + safeState;
            statusBadge.innerHTML = '<span class="status-dot"></span>' + label;
        }

        function clearOutput() {
            outputArea.innerHTML = "";
        }

        function appendOutput(text, type) {
            const line = document.createElement("div");
            line.className = "output-line output-" + (type || "stdout");
            line.textContent = text;
            outputArea.appendChild(line);
            outputArea.scrollTop = outputArea.scrollHeight;
        }

        function executeCode(code) {
            queuedCode = null;
            clearOutput();
            setRunningState(true);
            updateStatus("running", "Running...");
            worker.postMessage({ type: "run", code });
        }

        function setRunningState(running) {
            isRunning = running;
            runButton.disabled = running || !workerReady;
            stopButton.disabled = !running;
        }

        function rebuildWorker() {
            if (worker) {
                worker.terminate();
            }

            const workerSource = `
                let pyodideInstance;

                async function ensurePyodide() {
                    if (!pyodideInstance) {
                        self.postMessage({ type: "status", payload: "loading" });
                        importScripts("${PYODIDE_BASE_URL}pyodide.js");
                        pyodideInstance = await loadPyodide({ indexURL: "${PYODIDE_BASE_URL}" });

                        pyodideInstance.setStdout({
                            batched(text) {
                                if (text) {
                                    self.postMessage({ type: "stdout", payload: text });
                                }
                            }
                        });

                        pyodideInstance.setStderr({
                            batched(text) {
                                if (text) {
                                    self.postMessage({ type: "stderr", payload: text });
                                }
                            }
                        });

                        pyodideInstance.runPython(\`
import builtins
_blocked_modules = {"pyodide", "pyodide_js", "js", "micropip"}
_original_import = builtins.__import__
def _safe_import(name, globals=None, locals=None, fromlist=(), level=0):
    root = name.split(".", 1)[0]
    if root in _blocked_modules:
        raise ImportError(f"Importing {root!r} is disabled in this editor.")
    return _original_import(name, globals, locals, fromlist, level)
builtins.__import__ = _safe_import
\`);

                        self.fetch = async () => {
                            throw new Error("Network access is disabled in this environment.");
                        };

                        self.postMessage({ type: "ready" });
                    }

                    return pyodideInstance;
                }

                self.onmessage = async (event) => {
                    const { type, code } = event.data;

                    if (type === "warmup") {
                        try {
                            await ensurePyodide();
                        } catch (error) {
                            const message = error && error.message ? error.message : String(error);
                            self.postMessage({ type: "python-error", payload: message });
                            self.postMessage({ type: "status", payload: "error" });
                        }
                        return;
                    }

                    if (type === "run") {
                        const runtime = await ensurePyodide();
                        self.postMessage({ type: "status", payload: "running" });

                        let namespace;

                        try {
                            namespace = runtime.globals.get("dict")();
                            namespace.set("__builtins__", runtime.globals.get("__builtins__"));
                            await runtime.runPythonAsync(code, { globals: namespace });
                            self.postMessage({ type: "status", payload: "success" });
                        } catch (error) {
                            const message = error && error.message ? error.message : String(error);
                            self.postMessage({ type: "python-error", payload: message });
                            self.postMessage({ type: "status", payload: "error" });
                        } finally {
                            if (namespace) {
                                try {
                                    namespace.destroy();
                                } catch (cleanupError) {
                                    // ignore
                                }
                            }

                            self.postMessage({ type: "done" });
                        }
                    }
                };
            `;

            const blob = new Blob([workerSource], { type: "application/javascript" });
            const workerUrl = URL.createObjectURL(blob);
            worker = new Worker(workerUrl);
            URL.revokeObjectURL(workerUrl);

            worker.onmessage = (event) => {
                const { type, payload } = event.data;

                switch (type) {
                    case "ready":
                        workerReady = true;
                        if (!isRunning && !queuedCode) {
                            updateStatus("idle", "Ready");
                        }
                        runButton.disabled = false;
                        if (queuedCode) {
                            const codeToRun = queuedCode;
                            queuedCode = null;
                            executeCode(codeToRun);
                        }
                        break;

                    case "status":
                        if (payload === "loading") {
                            updateStatus("loading", "Preparing runtime...");
                        } else if (payload === "running") {
                            updateStatus("running", "Running...");
                        } else if (payload === "success") {
                            updateStatus("success", "Completed");
                        } else if (payload === "error") {
                            updateStatus("error", "Error");
                        }
                        break;

                    case "stdout":
                        appendOutput(payload, "stdout");
                        break;

                    case "stderr":
                        appendOutput(payload, "stderr");
                        break;

                    case "python-error":
                        appendOutput(payload, "error");
                        break;

                    case "done":
                        setRunningState(false);
                        break;

                    default:
                        break;
                }
            };

            worker.onerror = (error) => {
                appendOutput("Worker error: " + error.message, "error");
                updateStatus("error", "Worker error");
                setRunningState(false);
                workerReady = false;
            };

            queuedCode = null;
            workerReady = false;
            runButton.disabled = true;
            stopButton.disabled = true;

            try {
                worker.postMessage({ type: "warmup" });
            } catch (error) {
                appendOutput("Failed to initialize Python runtime.", "error");
            }
        }

        function ensureWorker() {
            if (!worker) {
                rebuildWorker();
            }
        }

        function initMonaco() {
            const loaderUrl = "https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs";

            require.config({ paths: { vs: loaderUrl } });

            window.MonacoEnvironment = {
                getWorkerUrl: function () {
                    const proxy = `
                        self.MonacoEnvironment = { baseUrl: "${loaderUrl}/" };
                        importScripts("${loaderUrl}/base/worker/workerMain.js");
                    `;
                    return URL.createObjectURL(new Blob([proxy], { type: "text/javascript" }));
                }
            };

            require(["vs/editor/editor.main"], function () {
                editorInstance = monaco.editor.create(document.getElementById("code-editor"), {
                    value: initialCode,
                    language: "python",
                    automaticLayout: true,
                    fontSize: 14,
                    theme: document.documentElement.getAttribute("data-theme") === "dark" ? "vs-dark" : "vs",
                    minimap: { enabled: false },
                    scrollBeyondLastLine: false,
                    tabSize: 4,
                    wordWrap: "on"
                });

                syncEditorTheme();
            });
        }

        function syncEditorTheme() {
            if (!window.monaco || !editorInstance) {
                return;
            }

            const isDark = document.documentElement.getAttribute("data-theme") === "dark";
            monaco.editor.setTheme(isDark ? "vs-dark" : "vs");
        }

        const themeObserver = new MutationObserver(function (mutations) {
            for (const mutation of mutations) {
                if (mutation.type === "attributes" && mutation.attributeName === "data-theme") {
                    syncEditorTheme();
                }
            }
        });

        themeObserver.observe(document.documentElement, { attributes: true });

        runButton.addEventListener("click", function () {
            ensureWorker();

            if (!editorInstance) {
                appendOutput("Editor is still loading. Please wait.", "info");
                return;
            }

            const code = editorInstance.getValue();

            if (!code.trim()) {
                appendOutput("Nothing to run. Add some Python code first.", "info");
                return;
            }

            if (!workerReady) {
                queuedCode = code;
                runButton.disabled = true;
                stopButton.disabled = true;
                clearOutput();
                appendOutput("Preparing Python runtime. Your code will run automatically once ready.", "info");
                updateStatus("loading", "Preparing runtime...");
                return;
            }

            executeCode(code);
        });

        stopButton.addEventListener("click", function () {
            if (!isRunning) {
                return;
            }

            appendOutput("Execution stopped by user.", "info");
            updateStatus("stopped", "Stopped");
            setRunningState(false);
            queuedCode = null;
            rebuildWorker();
        });

        importButton.addEventListener("click", function () {
            fileInput.click();
        });

        exportButton.addEventListener("click", function () {
            if (!editorInstance) {
                appendOutput("Editor is still loading. Please wait.", "info");
                return;
            }

            const code = editorInstance.getValue();
            const blob = new Blob([code], { type: "text/x-python" });
            const url = URL.createObjectURL(blob);
            const anchor = document.createElement("a");
            anchor.href = url;
            anchor.download = currentFilename || "code.py";
            document.body.appendChild(anchor);
            anchor.click();
            document.body.removeChild(anchor);
            URL.revokeObjectURL(url);
        });

        fileInput.addEventListener("change", function (event) {
            const file = event.target.files[0];

            if (!file) {
                return;
            }

            if (!/\.(py|txt)$/i.test(file.name)) {
                appendOutput("Only .py or .txt files are allowed.", "error");
                fileInput.value = "";
                return;
            }

            if (file.size > 200 * 1024) {
                appendOutput("File is too large. Maximum supported size is 200 KB.", "error");
                fileInput.value = "";
                return;
            }

            const reader = new FileReader();

            reader.onload = function (e) {
                if (editorInstance) {
                    editorInstance.setValue(e.target.result);
                    appendOutput("Loaded file: " + file.name, "info");
                    currentFilename = file.name;
                } else {
                    appendOutput("Editor is still loading. Please wait.", "info");
                }
            };

            reader.onerror = function () {
                appendOutput("Failed to read the selected file.", "error");
            };

            reader.readAsText(file, "utf-8");
            fileInput.value = "";
        });

        ensureWorker();
        initMonaco();
    })();
</script>

{% endblock %}
